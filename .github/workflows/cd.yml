name: CD - Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["CI Build & Push Docker"] # Dispara quando o CI terminar
    types: [ "completed" ]

permissions:
  contents: read

jobs:
  deploy:
    # Só executa se o CI foi bem-sucedido
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    # Executa no seu PC
    runs-on: self-hosted 
    
    # --- A MUDANÇA PRINCIPAL ESTÁ AQUI ---
    # Força o uso do 'cmd' (Command Prompt)
    defaults:
      run:
        shell: cmd
    # ------------------------------------

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- ESTE PASSO FOI TRADUZIDO PARA A SINTAXE DO CMD ---
      - name: Set vars
        id: vars
        run: |
          :: !! IMPORTANTE: SUBSTITUA '3riccolpo' SE O SEU UTILIZADOR DO DOCKERHUB FOR OUTRO !!
          echo IMAGE=3riccolpo/atividade >> %GITHUB_OUTPUT%

          :: Lógica corrigida para a TAG_SHA em CMD (pega os 7 primeiros caracteres)
          set FULL_SHA=${{ github.event.workflow_run.head_sha }}
          echo TAG_SHA=%FULL_SHA:~0,7% >> %GITHUB_OUTPUT%

          :: Define o namespace, usa 'default' se o secret estiver vazio
          set NS=${{ secrets.K8S_NAMESPACE }}
          if "%NS%" == "" set NS=default
          echo NAMESPACE=%NS% >> %GITHUB_OUTPUT%
          
      - name: Apply base manifests (Service, Prometheus, Grafana, Nginx)
        run: |
          :: O Kubectl funciona no cmd, mas as variáveis são acedidas com % %
          kubectl apply -n %NAMESPACE% -f k8s/atividade-service.yaml
          kubectl apply -n %NAMESPACE% -f k8s/prometheus-config.yaml
          kubectl apply -n %NAMESPACE% -f k8s/prometheus-deployment.yaml
          kubectl apply -n %NAMESPACE% -f k8s/grafana-deployment.yaml
          kubectl apply -n %NAMESPACE% -f k8s/grafana-service.yaml
          kubectl apply -n %NAMESPACE% -f k8s/nginx-deployment.yaml
          kubectl apply -n %NAMESPACE% -f k8s/nginx-service.yaml

      - name: Apply app deployment (first time)
        run: |
          kubectl apply -n %NAMESPACE% -f k8s/deployment.yaml

      - name: Set image to new tag
        run: |
          kubectl set image deployment/atividade atividade=%IMAGE%:%TAG_SHA% -n %NAMESPACE%

      - name: Wait rollout
        run: |
          kubectl rollout status deployment/atividade -n %NAMESPACE% --timeout=120s